import { Utils } from '../utils.mjs';
import { DialectBase, DialectKind } from './base/index.mjs';
import { ReadDialect } from './base/read.mjs';
import { WhereDialect } from './base/where.mjs';
import { JoinCondition, JoinMapper } from './join/index.mjs';
export class Dialect extends DialectBase {
    constructor(info) {
        super(info);
        this.update = this.update.bind(this);
    }
    create() {
        const { name, columns } = this.info;
        const cols = Object.keys(columns).map(key => {
            const column = columns[key];
            const colType = Utils.getRealColumnType(key, column);
            const colPrimary = column.primary ? ' PRIMARY KEY' : '';
            return `${Utils.quote(key)} ${colType}${colPrimary}`;
        });
        this.sql = `CREATE TABLE IF NOT EXISTS ${Utils.quote(name)} (${cols.join(', ')})`;
        this.kind = DialectKind.WRITE;
        return this;
    }
    drop() {
        this.sql = `DROP TABLE IF EXISTS ${Utils.quote(this.info.name)}`;
        this.kind = DialectKind.WRITE;
        return this;
    }
    select(fields) {
        this.kind = DialectKind.READ;
        return this.__select(fields);
    }
    single(fields) {
        this.kind = DialectKind.SINGLE;
        return this.__select(fields);
    }
    join(selector, clause) {
        const result = JoinCondition.buildSql(this.info, selector, clause);
        return new JoinMapper(this.info, result.tables, result.sql);
    }
    count() {
        this.sql = `SELECT COUNT(*) as count FROM ${Utils.quote(this.info.name)}`;
        return new ReadDialect(this.info, this.sql, DialectKind.COUNT);
    }
    any() {
        this.sql = `SELECT COUNT(*) as count FROM ${Utils.quote(this.info.name)}`;
        return new ReadDialect(this.info, this.sql, DialectKind.ANY);
    }
    insert(set, upsert) {
        this.kind = DialectKind.WRITE;
        if (set instanceof Array) {
            return this.__insertMany(set);
        }
        return this.__insert(set, upsert);
    }
    upsert(set) {
        return this.insert(set, true);
    }
    update(set) {
        const sql = `UPDATE ${Utils.quote(this.info.name)} SET ${Object.keys(set)
            .map(k => `${Utils.quote(k)} = ${Utils.asValue(this.info.columns[k].type, set[k])}`)
            .join(', ')}`;
        this.sql = sql;
        return new WhereDialect(this.info, this.sql, DialectKind.WRITE);
    }
    delete() {
        this.sql = `DELETE FROM ${Utils.quote(this.info.name)}`;
        return new WhereDialect(this.info, this.sql, DialectKind.WRITE);
    }
    __select(fields) {
        let sql;
        if (!fields || fields === '*') {
            sql = this._buildSelectFields(Object.keys(this.info.columns));
        }
        else {
            sql = this._select(fields);
        }
        this.sql = `SELECT ${sql} FROM ${Utils.quote(this.info.name)}`;
        return new ReadDialect(this.info, this.sql, this.kind);
    }
    __insert(set, upsert) {
        const fields = [];
        const values = [];
        for (const key of Object.keys(set)) {
            fields.push(key);
            values.push(Utils.asValue(this.info.columns[key].type, set[key]));
        }
        const sqlUpsert = upsert ? ' OR REPLACE' : '';
        const sql = `INSERT${sqlUpsert} INTO ${Utils.quote(this.info.name)} (${fields.map(Utils.quote)}) VALUES (${values})`;
        this.sql = sql;
        return this;
    }
    __insertMany(sets) {
        if (!sets.length) {
            throw new Error('No insert data defined.');
        }
        const fields = [];
        const set = sets.shift();
        const selectVal = [];
        for (const key of Object.keys(set)) {
            fields.push(key);
            selectVal.push(Utils.asValue(this.info.columns[key].type, set[key]) +
                ' AS ' +
                Utils.quote(key));
        }
        const unions = sets.map(s => {
            return `UNION ALL SELECT ${fields.map(k => Utils.asValue(this.info.columns[k].type, s[k]))}`;
        });
        const sql = `INSERT INTO ${Utils.quote(this.info.name)} (${fields.map(Utils.quote)}) SELECT ${selectVal} ${unions.join(' ')}`;
        this.sql = sql;
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgubWpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vUGFja2FnZXMvVHNQcm9qL3NyYy9TcWxpdGUtdHMvZGlhbGVjdHMvaW5kZXgubXRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDcEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQWdCLE1BQU0sa0JBQWtCLENBQUE7QUFDekUsT0FBTyxFQUFpQixXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUM1RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDL0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUU1RCxNQUFNLE9BQU8sT0FBZ0IsU0FBUSxXQUFtQjtJQUNwRCxZQUFZLElBQWtCO1FBQzFCLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNYLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDeEMsQ0FBQztJQUVELE1BQU07UUFDRixNQUFNLEVBQUMsSUFBSSxFQUFFLE9BQU8sRUFBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7UUFFakMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDeEMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzNCLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDcEQsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7WUFDdkQsT0FB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